\chapter{Implementation and Experimental Results}
\label{sec:results}

\input{content/impl_diffricceq}
\input{content/impl_parareal}

\section{Numerical Results}

\todo[inline]{separate results by sequential/parareal?}

\begin{example}[LTI Rail Profile]
The steel profile benchmark \cite{morwiki_steel} originating from \cite{Benner2005}:
\label{thm:results:rail}
\begin{equation}
\left\{
\begin{aligned}
  E^\T \dot X E &= C^\T C + A^\T X E + E^\T X A - E^\T X BB^\T X E \\
  E^\T X(t_f) E &= \tfrac{1}{100} C^\T C
\end{aligned}
\right.
\end{equation}
where
\begin{equation}
  E, A \in \Rnn,
  \enspace
  B \in \R^{n \times 7},
  \enspace
  C \in \R^{6 \times n}
\end{equation}
and $n=371$.
The problem's time span $[0,4500]$ corresponds to a resolution of \SI{10}{\milli\second},
\ie $t_f = \SI{45}{\second}$.
\end{example}

\subsection{Sequential Solvers}

\begin{figure}[t]
  \includegraphics[width=\textwidth]{figures/fig_results_sequential.pdf}
  \caption[Rosenbrock method applied to Rail problem]{%
    Several Rosenbrock schemes applied to the problem of \autoref{thm:results:rail}.
    Each scheme performs 450 steps ($\tau = \SI{100}{\milli\second}$).
    Top: trajectory of $K_{1,77}$ (same as \cite[Fig.~1]{Lang2015}),
    % same as Lang2015, Fig. 1
    % Lang2017, Fig 6.1 used K_{1,71} instead
    bottom: relative error compared to reference solution
    (900 steps of dense Rosenbrock scheme of order 4).
    Left: global time span $[\SI{0}{\second}, \SI{45}{\second}]$,
    right: zoom to $[\SI[round-mode=off]{43.2}{\second}, \SI{45}{\second}]$ (highlighted on the left).
  }
  \label{fig:results:sequential:rail}
\end{figure}

\begin{figure}[tp]
  \centering
  \includegraphics[width=0.75\textwidth]{figures/fig_results_sequential_rank.pdf}
  \caption[Numerical rank of low-rank sequential solutions to Rail problem]{%
    Numerical rank of low-rank sequential solutions to Rail problem,
    \cf~\cite[Figure~6.6b]{Lang2017}.
  }
\end{figure}

\begin{figure}[tp]
  \centering
  \includegraphics[width=0.75\textwidth]{figures/fig_results_sequential_err.pdf}
  \caption{Relative Error in $K$ between low-rank and dense solvers}
\end{figure}

\subsection{Parareal Solvers}
\label{sec:results:parareal}

Looking at \autoref{fig:results:parareal:rail},
there clearly is a problem with the low-rank version of \Ros{2}.
While the sample trajectory $K_{1,77}$ looks ok,
the relative error of the whole $K := B^\T X E$
\begin{equation}
  \frac{\norm{K(t) - K_\text{ref}(t)}_F}{\norm{K_\text{ref}(t)}_F}
\end{equation}
reveals the typical discontinuities at the interval bounds
$t_n = \SI{45}{\second} - n \cdot \SI{100}{\milli\second}$
before convergence is reached,
\cf \autoref{fig:pr:linear}.
Here, this is the case for $n > K = 10$, \ie $t \leq \SI{43.9}{\second}$.
But even for $t > \SI{43.9}{\second}$ there is a noticeable difference between
dense and low-rank versions of the algorithms involving \Ros{2}.
As the dense algorithms converged, so should the low-rank ones.
Only the parareal schemes of order 1/1 behave identically for dense and \ac{LRSIF} storage.
Their errors look similar to~\cite[Fig.~1]{Lang2015}.

\begin{figure}[t]
  \centering
  \includegraphics[width=\textwidth]{figures/fig_results_parareal.pdf}
  \caption[Parareal method applied to Rail problem]{%
    Several parareal schemes (Rosenbrock methods of given coarse/fine order)
    applied to the problem of \autoref{thm:results:rail},
    running on $N=450$ cores and
    computing up to $K=10$ refinements.
    Each scheme performs
    one coarse step ($\tau=\SI{100}{\milli\second}$) and
    100 fine steps ($\tau=\SI{1}{\milli\second}$) per stage.
    Top: trajectory of $K_{1,77}$ (same as \cite[Fig.~1]{Lang2015}),
    % same as Lang2015, Fig. 1
    % Lang2017, Fig 6.1 used K_{1,71} instead
    bottom: relative error compared to reference solution
    (dense parareal scheme of order 4/4).
    Left: global time span $[\SI{0}{\second}, \SI{45}{\second}]$,
    right: zoom to $[\SI[round-mode=off]{43.2}{\second}, \SI{45}{\second}]$ (highlighted on the left).
  }
  \label{fig:results:parareal:rail}
\end{figure}

\autoref{fig:results:parareal:timeline} shows the timeline diagrams corresponding to the solvers
Due to the problem with the low-rank \Ros{2} solver mentioned in the previous paragraph explains

\begin{figure}[tp]
  \includegraphics[width=\textwidth]{figures/fig_timeline_all.pdf}
  \caption[Timeline diagrams for parareal method applied to Rail problem]{%
    Timeline diagrams for the solutions described in \autoref{fig:results:parareal:rail}.
  }
  \label{fig:results:parareal:timeline}
\end{figure}

\begin{figure}[t]
  \centering
  \includegraphics[width=0.75\textwidth]{figures/fig_results_parareal_rank.pdf}
  \caption[Numerical rank of low-rank parareal solutions to Rail problem]{%
    Numerical rank of low-rank parareal solutions to Rail problem,
    \cf~\cite[Figure~6.6b]{Lang2017}.
    Only values at parareal interfaces $t_n$ are shown,
    which coincide with the time steps of the sequential solutions.
    The numerical ranks of \autoref{fig:results:sequential:rail} are shown in the background.
  }
\end{figure}

\todo[inline]{
Replicate \cite[Table~6.2]{Lang2017},
Estimate parallel efficiency based on timeline data,
}

\begin{table}[p]
  \centering
  \begin{tabular}{%
    l
    S[table-format=2] % k
    S[table-format=2.2] % warm-up
    S[table-format=-1.2] % ramp-up
    S[table-format=1.2] % G
    S[table-format=3.2] % F
    S[table-format=4.2] % par
    S[table-format=4.2] % par est
    S[round-precision=3, round-minimum=0.001, table-format=<1.3, scientific-notation=fixed, fixed-exponent=0] % err
  }
    \toprule
    Solver &
    {$k_N$} &
    {$\twarmup$} &
    {$\trampup$} &
    {$t_G$} &
    {$t_F$} &
    {$\tpar$} &
    {$\hattpar$} &
    {$\abs*{\frac{\hattpar-\tpar}{\tpar}}$} \\
    \midrule
    %TODO: Add uncertainties for low-rank t_F and t_G?
    \input{tables/warmup450_lr.tex}
    \addlinespace
    \input{tables/warmup450_de.tex}
    \addlinespace
    \input{tables/warmup450_ref.tex}
    \bottomrule
  \end{tabular}
  \caption[Timeline measurements for parareal algorithm, $N=450$, $K=10$]{%
    Timeline measurements for parareal algorithm, $N=450$, $K=10$.
    All measurements and estimates are as in \autoref{tab:impl:warmup}.
    The first column denotes the parareal scheme (coarse/fine order).
    Refer to Figures \ref{fig:results:parareal:timeline} and \ref{fig:impl:restart} for the corresponding timelines.
  }
  \label{tab:results:warmup}
\end{table}

\begin{table}[p]
  \centering
  \begin{tabular}{%
    l
    S[table-format=4.2] % par
    S[table-format=6.2] % seq est
    S[table-format=2.2] % speedup
    S[round-precision=3, round-minimum=0.001, table-format=1.3, scientific-notation=fixed, fixed-exponent=0] % efficiency
  }
    \toprule
    Solver &
    {$\tpar$} &
    {$\hattseq$} &
    {$\frac{\hattseq}{\tpar}$} &
    {$\frac{\hattseq}{N\cdot\tpar}$} \\
    \midrule
    \input{tables/speedup450_lr.tex}
    \addlinespace
    \input{tables/speedup450_de.tex}
    \addlinespace
    \input{tables/speedup450_ref.tex}
    \bottomrule
  \end{tabular}
  \caption[Speed-up and parallel efficiency of parareal algorithm, $N=450$, $K=10$]{%
    Speed-up and parallel efficiency of parareal algorithm, $N=450$, $K=10$.
    This table complements \autoref{tab:results:warmup}.
    The sequential runtime $\hattseq$ is estimated as $\sum_{n=1}^N t_F(n, k_n-1)$,
    \ie the total runtime of the last $F(U_{n-1}^*)$ computed.
    The parallel efficiency is evaluated for $N$ processors.
  }
\end{table}

\begin{table}
  \centering
  \begin{tabular}{%
    lc
    % tau
    S[table-format=3]
    % runtime
    S[table-format=4]
    S[table-format=4]
    % size
    S[table-format=2.3, round-precision=3]
    S[table-format=2.3, round-precision=3]
  }
    \toprule
    &&&
    \multicolumn{2}{c}{Runtime [\si{\second}]} &
    \multicolumn{2}{c}{Size [\si{\gibi\byte}]} \\
    \cmidrule(rl){4-5}
    \cmidrule(rl){6-7}
    Solver & Order & {Resolution [\si{\milli\second}]} &
    {Dense} & {LRSIF} &
    {Dense} & {LRSIF} \\
    \midrule % jobid dense, lowrank
    Sequential & 1 & 100 & 217 & 599 & 0.472 & 0.165 \\ % 351941, 351939
    Sequential & 2 & 100 & 602 & 708 & 0.472 & 0.231 \\ % 351942, 351940
    \addlinespace
    Parareal & 1/1 & 1 & 4724 & 2366 & 47.047 & 15.971 \\ % 351236, 351158
    Parareal & 1/2 & 1 & 5057 & 2775 & 47.047 & 19.084 \\ % 351235, 351167
    Parareal & 2/2 & 1 & 4730 & 5519 & 47.047 & 35.161 \\ % 351290, 351160
    \addlinespace
    Sequential & 4 & 50 & 1785 & {--} & 0.942 & {--} \\ % 351965
    Parareal & 4/4 & 1 & 4512 & {--} & 47.047 & {--} \\ % 351270
    \bottomrule
  \end{tabular}
  \caption[Runtime and storage requirements]{%
    Overall runtime (as reported by Slurm)
    including time to write results to disk,
    and storage requirements of solutions to Rail benchmark~\cite{morwiki_steel}.
    The resolution is the step size $\tau$ of the (fine) solver.
    The storage size includes both $X$ and $K$ trajectories,
    storing only $K$ would result in substantially smaller files.
  }
\end{table}

Storage ratio for parareal order 2/2 fits well to the estimated 1/3 of \autoref{thm:lowrank:rail}.
